<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ìˆ˜ì—…ì‹œê°„í‘œ v3.0.2.2</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    html, body { height: 100%; }
    body { margin: 0; overflow: hidden; }

    .slide-container {
      position: relative;
      width: 100%;
      height: 100%;
      background: #000;
      overflow: hidden;
    }

    .media-cover {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .media-contain {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }

    .youtube-iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 0;
    }

    .youtube-shorts-wrapper {
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: 100% !important;
      overflow: hidden !important;
      background: #000;
      margin: 0 !important;
      padding: 0 !important;
    }
    
    .youtube-shorts-wrapper iframe {
      position: absolute !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) scale(1.5) !important;
      transform-origin: center center !important;
      width: 100% !important;
      height: 100% !important;
      min-width: 100% !important;
      min-height: 100% !important;
      max-width: none !important;
      max-height: none !important;
      border: 0 !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    .gdrive-iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 0;
    }

    th, td { vertical-align: middle; }

    .fade { animation: fadeIn 250ms ease-out; }
    @keyframes fadeIn { from {opacity:.25} to {opacity:1} }

    .cell-text{
      white-space: normal;
      word-break: break-word;
      overflow-wrap: anywhere;
      line-height: 1.05;
    }

    .cell-divider{
      width: 100%;
      border-top: 1px solid rgba(0,0,0,.14);
      margin: 4px 0;
    }

    .cell-editor-wrap{
      width:100%;
      height:100%;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:stretch;
      padding: 4px;
      box-sizing: border-box;
    }
    .cell-editor-input{
      width:100%;
      border:0;
      outline:none;
      background:transparent;
      text-align:center;
      padding: 2px 4px;
      line-height: 1.05;
    }
    .cell-editor-input:focus{
      background: rgba(59,130,246,.10);
      border-radius: 6px;
    }

    .scroll-area { overflow: auto; }

    .login-screen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .login-box {
      background: white;
      padding: 3rem;
      border-radius: 1rem;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      text-align: center;
      max-width: 400px;
      width: 90%;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .modal-content {
      background: white;
      border-radius: 1rem;
      padding: 2rem;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .firebase-warning {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #fef3c7;
      border: 2px solid #f59e0b;
      padding: 1.5rem;
      border-radius: 0.75rem;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      max-width: 400px;
      z-index: 10000;
      animation: shake 0.5s;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    .fullscreen-exit-button {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.3);
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .fullscreen-exit-button:hover {
      background: rgba(220, 38, 38, 0.9);
      border-color: rgba(255, 255, 255, 0.8);
      transform: scale(1.05);
    }

    /* ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í‘œì‹œ */
    .realtime-badge {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(16, 185, 129, 0.9);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 6px;
      z-index: 1000;
      backdrop-filter: blur(10px);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* ì‚¬ìš©ì„¤ëª…ì„œ íŒì—… */
    .manual-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 9999;
      animation: fadeIn 0.2s ease-out;
    }

    .manual-sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: 500px;
      max-width: 90vw;
      background: white;
      box-shadow: 4px 0 20px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      animation: slideInLeft 0.3s ease-out;
      z-index: 10000;
    }

    @keyframes slideInLeft {
      from {
        transform: translateX(-100%);
      }
      to {
        transform: translateX(0);
      }
    }

    .manual-header {
      padding: 1.5rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .manual-body {
      flex: 1;
      overflow-y: auto;
      padding: 2rem;
    }

    .manual-body h2 {
      font-size: 1.5rem;
      font-weight: bold;
      margin-top: 2rem;
      margin-bottom: 1rem;
      color: #1f2937;
      border-bottom: 2px solid #667eea;
      padding-bottom: 0.5rem;
    }

    .manual-body h2:first-child {
      margin-top: 0;
    }

    .manual-body h3 {
      font-size: 1.25rem;
      font-weight: bold;
      margin-top: 1.5rem;
      margin-bottom: 0.75rem;
      color: #374151;
    }

    .manual-body h4 {
      font-size: 1.1rem;
      font-weight: bold;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
      color: #4b5563;
    }

    .manual-body p {
      margin-bottom: 0.75rem;
      line-height: 1.6;
      color: #374151;
    }

    .manual-body ul, .manual-body ol {
      margin-left: 1.5rem;
      margin-bottom: 1rem;
    }

    .manual-body li {
      margin-bottom: 0.5rem;
      line-height: 1.6;
    }

    .manual-body code {
      background: #f3f4f6;
      padding: 0.2rem 0.4rem;
      border-radius: 0.25rem;
      font-family: monospace;
      font-size: 0.9em;
    }

    .manual-body pre {
      background: #1f2937;
      color: #f9fafb;
      padding: 1rem;
      border-radius: 0.5rem;
      overflow-x: auto;
      margin-bottom: 1rem;
    }

    .manual-body pre code {
      background: transparent;
      color: inherit;
      padding: 0;
    }

    .manual-section {
      background: #f9fafb;
      border-left: 4px solid #667eea;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 0.25rem;
    }

    .manual-tip {
      background: #dbeafe;
      border-left: 4px solid #3b82f6;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 0.25rem;
    }

    .manual-warning {
      background: #fef3c7;
      border-left: 4px solid #f59e0b;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 0.25rem;
    }

    .manual-success {
      background: #d1fae5;
      border-left: 4px solid #10b981;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 0.25rem;
    }

    .manual-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }

    .manual-table th,
    .manual-table td {
      border: 1px solid #e5e7eb;
      padding: 0.5rem;
      text-align: left;
    }

    .manual-table th {
      background: #f3f4f6;
      font-weight: bold;
    }
  </style>
</head>

<body class="bg-gray-50 text-gray-900">
<div id="app" class="w-screen h-screen flex">

  <div v-if="!isFirebaseConfigured" class="firebase-warning">
    <div class="flex items-start gap-3">
      <i class="fa-solid fa-triangle-exclamation text-3xl text-amber-600"></i>
      <div>
        <h3 class="font-bold text-lg text-gray-900 mb-2">âš ï¸ Firebase ë¯¸ì„¤ì •</h3>
        <p class="text-sm text-gray-700 mb-3">
          Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.<br/>
          HTML íŒŒì¼ì„ ì—´ì–´ firebaseConfigë¥¼ ì…ë ¥í•˜ì„¸ìš”.
        </p>
      </div>
    </div>
  </div>

  <div v-if="!user" class="login-screen">
    <div class="login-box">
      <div class="mb-6">
        <i class="fa-solid fa-school text-6xl text-indigo-600 mb-4"></i>
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2">{{ schoolName }}</h1>
        <h2 class="text-xl font-bold text-gray-700">ìˆ˜ì—…ì‹œê°„í‘œ</h2>
      </div>
     
      <p class="text-gray-600 mb-8">
        ìˆ˜ì—…ì‹œê°„í‘œë¥¼ í™•ì¸í•˜ë ¤ë©´<br/>
        Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.
      </p>
     
      <button @click="login"
              class="w-full bg-white border-2 border-gray-300 hover:border-gray-400 text-gray-700 font-bold py-3 px-6 rounded-lg transition-all duration-200 flex items-center justify-center gap-3 shadow-md hover:shadow-lg">
        <i class="fa-brands fa-google text-xl"></i>
        <span class="text-lg">Google ë¡œê·¸ì¸</span>
      </button>
     
      <p class="mt-6 text-sm text-gray-500">
        í•™êµ êµ¬ì„±ì›ë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤
      </p>
    </div>
  </div>

  <template v-else>
    <!-- ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í‘œì‹œ -->
    <div v-if="!isKioskMode" class="realtime-badge">
      <i class="fa-solid fa-circle-dot"></i>
      <span>ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸</span>
    </div>

    <!-- ì‚¬ìš©ì„¤ëª…ì„œ íŒì—… -->
    <div v-if="showManual" class="manual-overlay" @click.self="showManual = false">
      <div class="manual-sidebar">
        <div class="manual-header">
          <div>
            <h1 class="text-2xl font-bold flex items-center gap-2">
              <i class="fa-solid fa-book"></i>
              ì‚¬ìš©ì„¤ëª…ì„œ
            </h1>
            <p class="text-sm opacity-90 mt-1">v3.0.2.2 | 2026-01-22</p>
          </div>
          <button @click="showManual = false"
                  class="text-white hover:bg-white/20 rounded-full w-10 h-10 flex items-center justify-center transition">
            <i class="fa-solid fa-xmark text-2xl"></i>
          </button>
        </div>

        <div class="manual-body">
          <h2>ğŸ“˜ êµ¬ë¡€ì¤‘í•™êµ ìˆ˜ì—…ì‹œê°„í‘œ ì‹œìŠ¤í…œ</h2>
          <p><strong>ì œì‘:</strong> êµê° ìµœê´‘ì²  (AI í˜‘ì—…)</p>

          <div class="manual-success">
            <p><strong>ğŸ”„ v3.0.2.2 ì—…ë°ì´íŠ¸</strong></p>
            <p>â€¢ ì‹œê°„í‘œ ê¸€ì í¬ê¸° ëŒ€í­ ì¦ê°€ (ì¹¸ì— ê½‰ ì°¨ê²Œ)</p>
            <p>â€¢ ê³¼ëª©ëª… ì§„í•œ ê²€ì€ìƒ‰ìœ¼ë¡œ ë³€ê²½</p>
            <p>â€¢ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ê¸°ëŠ¥</p>
          </div>

          <h2>ì£¼ìš” ê¸°ëŠ¥</h2>
          <ul>
            <li>âœ… ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (1~2ì´ˆ ë‚´ ìë™ ë°˜ì˜)</li>
            <li>âœ… ëŒ€í˜• ê¸€ì”¨ (ê°€ë…ì„± ìµœì í™”)</li>
            <li>âœ… ìœ íŠœë¸Œ ìˆì¸  ì§€ì›</li>
            <li>âœ… ìŠ¬ë¼ì´ë“œì‡¼</li>
            <li>âœ… í–‰ì‚¬ ê´€ë¦¬</li>
            <li>âœ… í‚¤ì˜¤ìŠ¤í¬ ëª¨ë“œ</li>
          </ul>

          <h2>ì—°ë½ì²˜</h2>
          <div class="manual-section">
            <p><strong>ë‹´ë‹¹ì:</strong> êµê° ìµœê´‘ì² </p>
            <p><strong>í•™êµ:</strong> êµ¬ë¡€ì¤‘í•™êµ</p>
          </div>

          <div style="text-align: center; margin-top: 3rem; padding-top: 2rem; border-top: 2px solid #e5e7eb;">
            <p class="text-gray-600">Â© 2026 êµ¬ë¡€ì¤‘í•™êµ</p>
            <p class="text-gray-600 text-sm mt-1">ì œì‘: êµê° ìµœê´‘ì²  (AI í˜‘ì—…)</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ìŠ¬ë¼ì´ë“œ ì „ì²´í™”ë©´ ì¢…ë£Œ ë²„íŠ¼ -->
    <button v-if="slideFullscreen"
            @click="toggleSlideFullscreen"
            class="fullscreen-exit-button">
      <i class="fa-solid fa-xmark"></i>
      <span>ì „ì²´í™”ë©´ ì¢…ë£Œ</span>
    </button>

    <!-- ì„¤ì • ëª¨ë‹¬ -->
    <div v-if="showSettingsModal" class="modal-overlay" @click.self="showSettingsModal = false">
      <div class="modal-content">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-bold">âš™ï¸ ì‹œìŠ¤í…œ ì„¤ì •</h2>
          <button @click="showSettingsModal = false" class="text-gray-500 hover:text-gray-700">
            <i class="fa-solid fa-xmark text-2xl"></i>
          </button>
        </div>

        <div class="space-y-6">
          <div>
            <label class="block font-bold mb-2">ğŸ« í•™êµ ì´ë¦„</label>
            <input v-model="tempSchoolName" type="text"
                   class="w-full border-2 rounded px-4 py-3 text-lg"
                   placeholder="ì˜ˆ: êµ¬ë¡€ì¤‘í•™êµ" />
          </div>

          <div>
            <label class="block font-bold mb-2">ğŸ“š í•™ê¸‰ êµ¬ì„±</label>
            <div class="space-y-3">
              <div v-for="grade in [1, 2, 3]" :key="grade" class="flex items-center gap-3">
                <span class="w-20 font-semibold">{{ grade }}í•™ë…„:</span>
                <select v-model="tempClassCounts[grade]" class="border-2 rounded px-3 py-2 flex-1">
                  <option :value="1">1ê°œë°˜</option>
                  <option :value="2">2ê°œë°˜</option>
                  <option :value="3">3ê°œë°˜</option>
                  <option :value="4">4ê°œë°˜</option>
                </select>
              </div>
            </div>
          </div>

          <div class="p-4 bg-blue-50 rounded-lg">
            <p class="text-sm text-gray-700">
              <strong>ğŸ’¡ ì•ˆë‚´:</strong><br/>
              â€¢ í•™êµ ì´ë¦„ê³¼ í•™ê¸‰ êµ¬ì„±ì„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤<br/>
              â€¢ ì €ì¥ í›„ ì‹œê°„í‘œë¥¼ ë‹¤ì‹œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤<br/>
              â€¢ ê¸°ì¡´ ë°ì´í„°ëŠ” ìœ ì§€ë˜ì§€ë§Œ í•™ê¸‰ì´ ì¤„ì–´ë“¤ë©´ í•´ë‹¹ ë°ì´í„°ëŠ” ìˆ¨ê²¨ì§‘ë‹ˆë‹¤
            </p>
          </div>

          <div class="flex gap-2">
            <button @click="saveSettings"
                    class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded">
              <i class="fa-solid fa-check"></i> ì €ì¥
            </button>
            <button @click="showSettingsModal = false"
                    class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 rounded">
              ì·¨ì†Œ
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- í–‰ì‚¬ ëª¨ë‹¬ -->
    <div v-if="showEventModal" class="modal-overlay" @click.self="showEventModal = false">
      <div class="modal-content">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-bold">í–‰ì‚¬ ê´€ë¦¬</h2>
          <button @click="showEventModal = false" class="text-gray-500 hover:text-gray-700">
            <i class="fa-solid fa-xmark text-2xl"></i>
          </button>
        </div>

        <div class="mb-4 p-4 bg-blue-50 rounded-lg">
          <p class="text-sm text-gray-700 mb-2"><strong>ë“±ë¡ëœ í–‰ì‚¬:</strong></p>
          <div v-if="Object.keys(events).length === 0" class="text-gray-500 text-sm">
            (ë“±ë¡ëœ í–‰ì‚¬ ì—†ìŒ)
          </div>
          <div v-else class="space-y-1 text-sm">
            <div v-for="(evt, period) in events" :key="period" class="flex items-center justify-between">
              <span>{{ period }}êµì‹œ: {{ formatEventDisplay(evt) }}</span>
              <button @click="deleteEvent(period)" class="text-red-600 hover:text-red-800 text-xs">
                <i class="fa-solid fa-trash"></i> ì‚­ì œ
              </button>
            </div>
          </div>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block font-bold mb-2">êµì‹œ ì„ íƒ</label>
            <select v-model="eventForm.period" class="w-full border rounded px-3 py-2">
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              <option v-for="p in [1,2,3,4,5,6,7]" :key="p" :value="p">{{ p }}êµì‹œ</option>
            </select>
          </div>

          <div>
            <label class="block font-bold mb-2">í–‰ì‚¬ ë²”ìœ„</label>
            <select v-model="eventForm.type" class="w-full border rounded px-3 py-2">
              <option value="all">ì „ì²´ (ëª¨ë“  í•™ê¸‰)</option>
              <option value="grade">í•™ë…„ë³„</option>
              <option value="class">í•™ê¸‰ë³„</option>
            </select>
          </div>

          <div v-if="eventForm.type === 'all'">
            <label class="block font-bold mb-2">í–‰ì‚¬ëª…</label>
            <input v-model="eventForm.allName" type="text"
                   class="w-full border rounded px-3 py-2"
                   placeholder="ì˜ˆ: ì…í•™ì‹, ì¡¸ì—…ì‹" />
          </div>

          <div v-if="eventForm.type === 'grade'" class="space-y-2">
            <label class="block font-bold mb-2">í•™ë…„ë³„ í–‰ì‚¬ëª…</label>
            <div v-for="g in [1,2,3]" :key="g" class="flex items-center gap-2">
              <span class="w-20 font-semibold">{{ g }}í•™ë…„:</span>
              <input v-model="eventForm.gradeNames[g]" type="text"
                     class="flex-1 border rounded px-3 py-2"
                     :placeholder="'ì˜ˆ: ì²´í—˜í•™ìŠµ (ë¹ˆì¹¸=ì¼ë°˜ìˆ˜ì—…)'" />
            </div>
          </div>

          <div v-if="eventForm.type === 'class'" class="space-y-2">
            <label class="block font-bold mb-2">í•™ê¸‰ë³„ í–‰ì‚¬ëª…</label>
            <div v-for="cls in classes" :key="cls" class="flex items-center gap-2">
              <span class="w-24 font-semibold">{{ cls }}:</span>
              <input v-model="eventForm.classNames[cls]" type="text"
                     class="flex-1 border rounded px-3 py-2"
                     :placeholder="'ì˜ˆ: í˜„ì¥í•™ìŠµ (ë¹ˆì¹¸=ì¼ë°˜ìˆ˜ì—…)'" />
            </div>
          </div>

          <div class="flex gap-2">
            <button @click="saveEvent"
                    class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 rounded">
              <i class="fa-solid fa-check"></i> ì €ì¥
            </button>
            <button @click="showEventModal = false"
                    class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 rounded">
              ì·¨ì†Œ
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ìŠ¬ë¼ì´ë“œ ì˜ì—­ -->
    <aside v-if="showSlides" class="h-full bg-black relative overflow-hidden" :style="slideAreaStyle">
      <div v-if="slides.length" class="slide-container">
        <template v-for="(s, idx) in slides" :key="idx">
          <div v-show="idx === currentSlideIndex" class="absolute inset-0 fade">
            <video v-if="s.type === 'video'"
                   :ref="el => { if(el && idx === currentSlideIndex) playVideo(el) }"
                   :class="slideFullscreen ? 'media-contain' : 'media-cover'"
                   :src="s.url"
                   autoplay
                   muted
                   loop
                   playsinline
                   @loadeddata="onVideoLoaded(s.url)"
                   @error="handleMediaError('video', s.url, $event)"></video>

            <iframe v-else-if="s.type === 'gdrive-video'"
                    class="gdrive-iframe"
                    :src="s.previewUrl"
                    title="Google Drive Video"
                    allow="autoplay"
                    allowfullscreen></iframe>

            <div v-else-if="s.type === 'youtube-shorts'" class="youtube-shorts-wrapper">
              <iframe :src="s.embedUrl"
                      :id="'youtube-shorts-' + idx"
                      title="YouTube Shorts"
                      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                      referrerpolicy="strict-origin-when-cross-origin"
                      allowfullscreen></iframe>
            </div>

            <iframe v-else-if="s.type === 'youtube'"
                    class="youtube-iframe"
                    :src="s.embedUrl"
                    :id="'youtube-' + idx"
                    title="YouTube"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                    referrerpolicy="strict-origin-when-cross-origin"
                    allowfullscreen></iframe>

            <img v-else-if="s.type === 'gdrive-image'"
                 :class="slideFullscreen ? 'media-contain' : 'media-cover'"
                 :src="s.thumbnailUrl"
                 alt="Google Drive Image"
                 @load="onImageLoaded(s.url)"
                 @error="handleMediaError('gdrive-image', s.url, $event)" />

            <img v-else
                 :class="slideFullscreen ? 'media-contain' : 'media-cover'"
                 :src="s.url"
                 alt="slide"
                 @load="onImageLoaded(s.url)"
                 @error="handleMediaError('image', s.url, $event)" />
          </div>
        </template>
      </div>

      <div v-else class="w-full h-full flex items-center justify-center text-white/60 text-center p-6">
        <div>
          <div class="text-2xl font-bold mb-2">ìŠ¬ë¼ì´ë“œê°€ ì—†ìŠµë‹ˆë‹¤</div>
          <div class="text-sm">ê´€ë¦¬ì ëª¨ë“œì—ì„œ URLì„ ì¶”ê°€í•˜ì„¸ìš”</div>
        </div>
      </div>

      <div v-if="isAdminMode && !isKioskMode && !slideFullscreen"
           class="absolute bottom-0 left-0 right-0 bg-black/80 text-white p-3 max-h-64 overflow-auto z-10">
        <div class="flex items-center justify-between mb-2">
          <div class="font-bold">ìŠ¬ë¼ì´ë“œ ê´€ë¦¬ ({{ slides.length }})</div>
          <button @click="addSlidePrompt"
                  class="bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-sm">
            <i class="fa-solid fa-plus"></i> ì¶”ê°€
          </button>
        </div>

        <div v-for="(s, idx) in slides" :key="'m'+idx"
             class="flex items-center gap-2 bg-white/10 rounded px-2 py-1 mb-2">
          <div class="flex-1 truncate text-xs">
            <span class="font-bold">{{ s.type }}</span> |
            <span class="opacity-75">{{ s.displayUrl || s.url.substring(0, 40) }}...</span>
          </div>
          <button class="px-2 py-1 hover:bg-white/10 rounded" @click="moveSlide(idx, -1)" title="ìœ„ë¡œ">
            <i class="fa-solid fa-arrow-up"></i>
          </button>
          <button class="px-2 py-1 hover:bg-white/10 rounded" @click="moveSlide(idx, 1)" title="ì•„ë˜ë¡œ">
            <i class="fa-solid fa-arrow-down"></i>
          </button>
          <button class="px-2 py-1 hover:bg-red-500/20 rounded text-red-200" @click="deleteSlide(idx)" title="ì‚­ì œ">
            <i class="fa-solid fa-trash"></i>
          </button>
        </div>
      </div>
    </aside>

    <!-- ë©”ì¸ ì‹œê°„í‘œ ì˜ì—­ -->
    <main class="h-full flex-1 flex flex-col bg-white" :style="mainAreaStyle">

      <header class="shrink-0 border-b bg-white px-4 py-3">
        <div class="flex items-center justify-between">
          <div class="flex-1 text-center select-none">
            <div class="font-extrabold tracking-tight" :class="isKioskMode ? 'text-4xl' : 'text-2xl'">
              {{ todayDateStr }} ({{ todayDayLabel }}) {{ schoolName }} ìˆ˜ì—…ì‹œê°„í‘œ
            </div>
          </div>

          <div class="shrink-0 flex gap-2">
            <!-- ì‚¬ìš©ì„¤ëª…ì„œ ë²„íŠ¼ -->
            <button v-if="!isKioskMode" @click="showManual = true"
                    class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded font-bold">
              <i class="fa-solid fa-book"></i>
              ì‚¬ìš©ì„¤ëª…ì„œ
            </button>

            <button @click="toggleKiosk"
                    class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded font-bold">
              <i class="fa-solid" :class="isKioskMode ? 'fa-compress' : 'fa-expand'"></i>
              ì „ì²´í™”ë©´
            </button>

            <template v-if="!isKioskMode">
              <button @click="toggleAdmin"
                      class="px-4 py-2 rounded font-bold"
                      :class="isAdminMode ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-900'">
                {{ isAdminMode ? 'ê´€ë¦¬ì ì¢…ë£Œ' : 'ê´€ë¦¬ì ëª¨ë“œ' }}
              </button>
             
              <div class="flex items-center gap-2 bg-gray-100 px-3 py-2 rounded">
                <img v-if="user.photoURL" :src="user.photoURL" class="w-8 h-8 rounded-full" />
                <i v-else class="fa-solid fa-user-circle text-2xl text-gray-600"></i>
                <span class="text-sm font-semibold text-gray-700">{{ userName }}</span>
              </div>
             
              <button @click="logout"
                      class="px-4 py-2 rounded font-bold bg-gray-200 hover:bg-gray-300">
                ë¡œê·¸ì•„ì›ƒ
              </button>
            </template>
          </div>
        </div>
      </header>

      <section v-if="isAdminMode && !isKioskMode"
               class="shrink-0 border-b bg-gray-50 px-4 py-3">
        <div class="text-xs text-gray-500 mb-2 text-right">
          It was produced by Choi Kwang-chul, vice principal, with the help of AI. "Student schedule guide ver3.0.2.2"
        </div>
        
        <div class="flex flex-wrap items-center gap-3">
          <div class="font-bold text-gray-700 mr-2">
            <i class="fa-solid fa-gear"></i> ê´€ë¦¬ì ë„êµ¬
          </div>

          <label class="text-sm text-gray-700 font-bold flex items-center gap-2">
            í¸ì§‘ ìš”ì¼:
            <select v-model="selectedDay" @change="loadDayData" class="border-2 border-blue-500 rounded px-3 py-2 bg-white font-bold text-base">
              <option v-for="d in weekdays" :key="d" :value="d">{{ d}}ìš”ì¼</option>
            </select>
          </label>

          <button @click="loadBaseToGrid"
                  class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded font-bold">
            <i class="fa-solid fa-rotate-left"></i> ê¸°ë³¸ì‹œê°„í‘œ ë¶ˆëŸ¬ì˜¤ê¸°
          </button>

          <button @click="saveOverride"
                  class="bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 rounded font-bold">
            <i class="fa-solid fa-save"></i> ìˆ˜ì—…ë³€ê²½ ì €ì¥
          </button>

          <button @click="openEventModal"
                  class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded font-bold">
            <i class="fa-solid fa-calendar-days"></i> í–‰ì‚¬ ê´€ë¦¬
          </button>

          <button @click="saveBase"
                  class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded font-bold">
            <i class="fa-solid fa-floppy-disk"></i> í•™ê¸°ì´ˆ ê¸°ë³¸ì‹œê°„í‘œ ì €ì¥
          </button>

          <button @click="toggleSlides"
                  class="px-4 py-2 rounded font-bold"
                  :class="showSlides ? 'bg-green-600 text-white' : 'bg-gray-300 text-gray-900'">
            <i class="fa-solid" :class="showSlides ? 'fa-eye' : 'fa-eye-slash'"></i>
            ìŠ¬ë¼ì´ë“œ {{ showSlides ? 'ì¼œì§' : 'êº¼ì§' }}
          </button>

          <button @click="toggleSlideFullscreen"
                  class="px-4 py-2 rounded font-bold"
                  :class="slideFullscreen ? 'bg-cyan-600 text-white' : 'bg-gray-300 text-gray-900'">
            <i class="fa-solid fa-tv"></i>
            ìŠ¬ë¼ì´ë“œ {{ slideFullscreen ? 'ì „ì²´í™”ë©´' : 'ì¼ë°˜' }}
          </button>

          <button @click="openSettings"
                  class="px-4 py-2 rounded font-bold bg-gray-600 hover:bg-gray-700 text-white">
            <i class="fa-solid fa-cog"></i> ì‹œìŠ¤í…œ ì„¤ì •
          </button>

          <div class="ml-auto text-xs text-gray-500">
            í˜„ì¬: {{ selectedDay }}ìš”ì¼ í¸ì§‘ì¤‘
          </div>
        </div>
      </section>

      <section class="flex-1"
               :class="(isAdminMode && !isKioskMode) ? 'scroll-area p-4' : (isKioskMode ? 'overflow-hidden p-2' : 'overflow-hidden p-4')">

        <div class="w-full border-2 border-gray-300 rounded-lg overflow-hidden bg-white"
             :class="(isAdminMode && !isKioskMode) ? '' : 'h-full'">

          <table class="w-full table-fixed border-collapse" :class="(isAdminMode && !isKioskMode) ? '' : 'h-full'">
            <thead>
            <tr>
              <th class="border border-gray-300 w-28 bg-green-100"
                  :class="isKioskMode ? 'text-2xl py-4' : 'text-lg py-3'">
                êµì‹œ
              </th>

              <th v-for="cls in classes" :key="cls"
                  class="border border-gray-300 font-extrabold"
                  :class="[isKioskMode ? 'text-2xl py-4' : 'text-lg py-3', colHeaderBg(cls)]">
                {{ classLabel(cls) }}
              </th>
            </tr>
            </thead>

            <tbody>
            <template v-for="row in tableRows" :key="row.key">

              <tr v-if="row.type==='lunch'" class="bg-amber-50" :style="rowStyle(row)">
                <td class="border border-gray-300 bg-green-100">
                  <div class="w-full h-full flex items-center justify-center font-extrabold"
                       :class="isKioskMode ? 'text-2xl' : 'text-lg'">ì ì‹¬</div>
                </td>
                <td :colspan="classes.length" class="border border-gray-300">
                  <div class="w-full h-full flex items-center justify-center font-extrabold text-gray-800"
                       :class="isKioskMode ? 'text-3xl' : 'text-xl'">ì ì‹¬ì‹œê°„</div>
                </td>
              </tr>

              <tr v-else :style="rowStyle(row)">
                <td class="border border-gray-300 bg-green-100">
                  <div class="w-full h-full flex items-center justify-center"
                       :class="isKioskMode ? 'text-4xl font-extrabold' : 'text-xl font-bold'">
                    {{ row.period }}êµì‹œ
                  </div>
                </td>

                <td v-if="isFixedThursdayCreative(row.period)"
                    :colspan="classes.length"
                    class="border border-gray-300 bg-gray-50">
                  <div class="w-full h-full flex items-center justify-center text-center font-extrabold text-gray-800 cell-text"
                       :class="isKioskMode ? 'text-4xl' : 'text-2xl'">
                    ì°½ì˜ì ì²´í—˜í™œë™
                  </div>
                </td>

                <template v-else>
                  <template v-for="(group, gIdx) in getEventGroups(row.period)" :key="'g'+gIdx">
                    <td v-if="group.isEvent"
                        :colspan="group.classes.length"
                        :class="['border border-gray-300', getEventCellBgClass(row.period, group)]">
                      <div class="w-full h-full flex items-center justify-center text-center font-extrabold text-purple-900 cell-text"
                           :class="isKioskMode ? 'text-3xl' : 'text-xl'">
                        {{ group.eventName }}
                      </div>
                    </td>

                    <td v-else v-for="cls in group.classes" :key="cls"
                        class="border border-gray-300 p-0"
                        :class="[colBodyBg(cls), getCellBgClass(row.period, cls)]">

                      <div v-if="isAdminMode && !isKioskMode" class="cell-editor-wrap">
                        <input class="cell-editor-input font-black text-black"
                               style="font-size: 1.65rem;"
                               :data-period="row.period"
                               :data-class="cls"
                               data-part="subject"
                               :value="getSubject(grid[row.period][cls])"
                               @input="(e)=>setCellSubject(row.period, cls, e.target.value)"
                               @keydown.enter.prevent="handleEnter(row.period, cls, 'subject')"
                               placeholder="ê³¼ëª©ëª…" />

                        <div class="cell-divider"></div>

                        <input class="cell-editor-input font-bold text-gray-700"
                               style="font-size: 1.25rem;"
                               :data-period="row.period"
                               :data-class="cls"
                               data-part="teacher"
                               :value="getTeacher(grid[row.period][cls])"
                               @input="(e)=>setCellTeacher(row.period, cls, e.target.value)"
                               @keydown.enter.prevent="handleEnter(row.period, cls, 'teacher')"
                               placeholder="êµì‚¬ëª…" />
                      </div>

                      <div v-else class="w-full h-full flex items-center justify-center text-center px-1">
                        <div class="flex flex-col items-center justify-center w-full">
                          <div class="cell-text font-black text-black"
                               :style="kioskSubjectStyle(getSubject(grid[row.period][cls]))">
                            {{ getSubject(grid[row.period][cls]) }}
                          </div>

                          <div class="cell-divider" style="margin:6px 0;"></div>

                          <div class="cell-text font-bold text-gray-700"
                               :style="kioskTeacherStyle(getTeacher(grid[row.period][cls]))">
                            {{ getTeacher(grid[row.period][cls]) }}
                          </div>
                        </div>
                      </div>

                    </td>
                  </template>
                </template>
              </tr>
            </template>
            </tbody>
          </table>
        </div>

      </section>

    </main>
  </template>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAiij8Jnb3AmPNAkzsPQUfLQnvmyx9UP6c",
    authDomain: "classes-51b3d.firebaseapp.com",
    projectId: "classes-51b3d",
    storageBucket: "classes-51b3d.firebasestorage.app",
    messagingSenderId: "850176624202",
    appId: "1:850176624202:web:6c4efb6de34c94b26d88b3"
  };

  const fbApp = initializeApp(firebaseConfig);
  const db = getFirestore(fbApp);
  const auth = getAuth(fbApp);
  const provider = new GoogleAuthProvider();

  const { createApp, ref, computed, onMounted, nextTick, watch, onUnmounted } = Vue;

  createApp({
    setup() {
      const weekdays = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ'];
      const configRef = doc(db, "school", "config");

      const user = ref(null);
      const isAdminMode = ref(false);
      const isKioskMode = ref(false);
      const showSlides = ref(true);
      const slideFullscreen = ref(false);
      const showManual = ref(false);

      const schoolName = ref('êµ¬ë¡€ì¤‘í•™êµ');
      const classCounts = ref({ 1: 2, 2: 2, 3: 2 });
      
      const showSettingsModal = ref(false);
      const tempSchoolName = ref('');
      const tempClassCounts = ref({ 1: 2, 2: 2, 3: 2 });

      const classes = computed(() => {
        const result = [];
        for (let grade = 1; grade <= 3; grade++) {
          const count = classCounts.value[grade] || 2;
          for (let classNum = 1; classNum <= count; classNum++) {
            result.push(`${grade}-${classNum}`);
          }
        }
        return result;
      });

      const slideAreaStyle = computed(() => {
        if (slideFullscreen.value) {
          return { width: '100%' };
        }
        return { width: isKioskMode.value ? '20%' : '24%' };
      });

      const mainAreaStyle = computed(() => {
        if (slideFullscreen.value) {
          return { display: 'none' };
        }
        return {};
      });

      const isFirebaseConfigured = computed(() => {
        return firebaseConfig.apiKey && 
               firebaseConfig.projectId && 
               !firebaseConfig.apiKey.includes('YOUR_') &&
               !firebaseConfig.projectId.includes('YOUR_');
      });

      const today = new Date();
      
      const todayDateStr = computed(() => {
        const y = today.getFullYear();
        const m = String(today.getMonth() + 1).padStart(2, '0');
        const d = String(today.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
      });
     
      const todayDayLabel = computed(() => {
        const dayNames = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
        return dayNames[today.getDay()];
      });

      const selectedDay = ref(weekdays.includes(todayDayLabel.value) ? todayDayLabel.value : 'ì›”');

      const slides = ref([]);
      const currentSlideIndex = ref(0);
      const slideTimer = ref(null);

      const base = ref(makeEmptyTimetable());
      const baseEvents = ref({});
      const overrides = ref({});
      const events = ref({});
      const grid = ref(makeEmptyTimetable());

      const showEventModal = ref(false);
      const eventForm = ref({
        period: '',
        type: 'all',
        allName: '',
        gradeNames: { 1: '', 2: '', 3: '' },
        classNames: {}
      });

      // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ë¦¬ìŠ¤ë„ˆ
      let unsubscribeTimetable = null;

      const userName = computed(() => {
        if (!user.value) return '';
        return user.value.displayName || user.value.email || 'ì‚¬ìš©ì';
      });

      function handleEscKey(event) {
        if (event.key === 'Escape') {
          if (slideFullscreen.value) {
            slideFullscreen.value = false;
          } else if (showManual.value) {
            showManual.value = false;
          }
        }
      }

      function toggleSlides() {
        showSlides.value = !showSlides.value;
        if (slideFullscreen.value && !showSlides.value) {
          slideFullscreen.value = false;
        }
      }

      function toggleSlideFullscreen() {
        slideFullscreen.value = !slideFullscreen.value;
        if (slideFullscreen.value) {
          showSlides.value = true;
        }
      }

      function openSettings() {
        tempSchoolName.value = schoolName.value;
        tempClassCounts.value = { ...classCounts.value };
        showSettingsModal.value = true;
      }

      async function saveSettings() {
        schoolName.value = tempSchoolName.value || 'êµ¬ë¡€ì¤‘í•™êµ';
        classCounts.value = { ...tempClassCounts.value };
        
        try {
          await setDoc(configRef, { 
            schoolName: schoolName.value,
            classCounts: classCounts.value,
            slides: slides.value 
          }, { merge: true });
          
          showSettingsModal.value = false;
          alert('âœ… ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\nì‹œê°„í‘œë¥¼ ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          
          grid.value = makeEmptyTimetable();
          await loadDayData();
        } catch (error) {
          console.error('âŒ ì„¤ì • ì €ì¥ ì‹¤íŒ¨:', error);
          alert('ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ' + error.message);
        }
      }

      watch(showSlides, (newValue) => {
        if (newValue) {
          startSlideTimer();
        } else {
          if (slideTimer.value) {
            clearTimeout(slideTimer.value);
            slideTimer.value = null;
          }
        }
      });

      function onVideoLoaded(url) {
        console.log('âœ… ë¹„ë””ì˜¤ ë¡œë“œ:', url.substring(0, 50));
      }

      function onImageLoaded(url) {
        console.log('âœ… ì´ë¯¸ì§€ ë¡œë“œ:', url.substring(0, 50));
      }

      function handleMediaError(type, url, event) {
        console.error(`âŒ ${type} ë¡œë“œ ì‹¤íŒ¨:`, url);
      }

      function playVideo(videoEl) {
        if (!videoEl) return;
        videoEl.play().catch(e => {
          console.warn('ë¹„ë””ì˜¤ ìë™ì¬ìƒ ì‹¤íŒ¨:', e);
        });
      }

      function makeEmptyTimetable() {
        const t = {};
        for (let p = 1; p <= 7; p++) {
          t[p] = {};
          for (const c of classes.value) t[p][c] = '';
        }
        return t;
      }

      function classLabel(cls) {
        const [g, b] = String(cls).split('-');
        return `${g}í•™ë…„ ${b}ë°˜`;
      }

      function gradeFromClass(cls) {
        return Number(String(cls).split('-')[0]);
      }

      function colHeaderBg(cls) {
        const g = gradeFromClass(cls);
        if (g === 1) return 'bg-yellow-100';
        if (g === 2) return 'bg-sky-100';
        return 'bg-pink-100';
      }
     
      function colBodyBg(cls) {
        const g = gradeFromClass(cls);
        if (g === 1) return 'bg-yellow-50';
        if (g === 2) return 'bg-sky-50';
        return 'bg-pink-50';
      }

      function getCellBgClass(period, cls) {
        if (isOverrideCell(period, cls)) {
          return 'bg-red-100 ring-2 ring-red-300';
        }
        return '';
      }

      function getEventCellBgClass(period, group) {
        const baseEvt = baseEvents.value[String(period)];
        const currEvt = events.value[String(period)];
       
        if (JSON.stringify(baseEvt) !== JSON.stringify(currEvt)) {
          return 'bg-red-100 ring-2 ring-red-300';
        }
        return 'bg-purple-50';
      }

      function dayIndexFromKorean(day) {
        const map = { 'ì¼':0,'ì›”':1,'í™”':2,'ìˆ˜':3,'ëª©':4,'ê¸ˆ':5,'í† ':6 };
        return map[day] ?? today.getDay();
      }
     
      function isFixedThursdayCreative(p) {
        const dIdx = dayIndexFromKorean(selectedDay.value);
        return (p === 7 && dIdx === 4);
      }

      function getEventGroups(period) {
        const evt = events.value[String(period)];
        if (!evt) {
          return [{ isEvent: false, classes: classes.value }];
        }

        const groups = [];

        if (evt.type === 'all') {
          groups.push({
            isEvent: true,
            eventName: evt.name,
            classes: classes.value
          });
        } else if (evt.type === 'grade') {
          for (let g = 1; g <= 3; g++) {
            const gradeName = evt.data[g];
            const gradeClasses = classes.value.filter(c => gradeFromClass(c) === g);
           
            if (gradeName) {
              groups.push({
                isEvent: true,
                eventName: gradeName,
                classes: gradeClasses
              });
            } else {
              groups.push({
                isEvent: false,
                classes: gradeClasses
              });
            }
          }
        } else if (evt.type === 'class') {
          const eventClasses = [];
          const normalClasses = [];
         
          for (const cls of classes.value) {
            if (evt.data[cls]) {
              eventClasses.push({ cls, name: evt.data[cls] });
            } else {
              normalClasses.push(cls);
            }
          }
         
          const eventMap = {};
          for (const { cls, name } of eventClasses) {
            if (!eventMap[name]) eventMap[name] = [];
            eventMap[name].push(cls);
          }
         
          for (const [name, clsList] of Object.entries(eventMap)) {
            groups.push({
              isEvent: true,
              eventName: name,
              classes: clsList
            });
          }
         
          if (normalClasses.length > 0) {
            groups.push({
              isEvent: false,
              classes: normalClasses
            });
          }
        }

        return groups.length > 0 ? groups : [{ isEvent: false, classes: classes.value }];
      }

      function formatEventDisplay(evt) {
        if (evt.type === 'all') {
          return `ì „ì²´ - ${evt.name}`;
        } else if (evt.type === 'grade') {
          const parts = [];
          for (const [g, name] of Object.entries(evt.data)) {
            if (name) parts.push(`${g}í•™ë…„(${name})`);
          }
          return parts.join(', ') || '(ì—†ìŒ)';
        } else if (evt.type === 'class') {
          const parts = [];
          for (const [cls, name] of Object.entries(evt.data)) {
            if (name) parts.push(`${cls}(${name})`);
          }
          return parts.join(', ') || '(ì—†ìŒ)';
        }
        return '';
      }

      const periodCount = computed(() => 7);
      const lunchHeightPct = computed(() => (isKioskMode.value ? 5 : 6));
      const periodHeightPct = computed(() => (100 - lunchHeightPct.value) / periodCount.value);

      const tableRows = computed(() => {
        const rows = [];
        for (let p = 1; p <= 7; p++) {
          rows.push({ type: 'period', period: p, key: 'p'+p });
          if (p === 4) rows.push({ type: 'lunch', key: 'lunch' });
        }
        return rows;
      });

      function rowStyle(row) {
        if (row.type === 'lunch') return { height: lunchHeightPct.value + '%' };
        return { height: periodHeightPct.value + '%' };
      }

      function parseCell(v) {
        const s = String(v || '');
        if (!s.trim()) return { subject:'', teacher:'' };
        if (s.includes('\n')) {
          const parts = s.split('\n');
          return { subject: (parts[0]||'').trim(), teacher: parts.slice(1).join(' ').trim() };
        }
        return { subject: s.trim(), teacher:'' };
      }
     
      function getSubject(v){ return parseCell(v).subject; }
      function getTeacher(v){ return parseCell(v).teacher; }

      function setCell(p, cls, subject, teacher) {
        const s = String(subject||'').trim();
        const t = String(teacher||'').trim();
        if (!grid.value[p]) grid.value[p] = {};
        grid.value[p][cls] = t ? `${s}\n${t}` : `${s}`;
      }
     
      function setCellSubject(p, cls, subject) {
        const cur = parseCell(grid.value[p]?.[cls] || '');
        setCell(p, cls, subject, cur.teacher);
      }
     
      function setCellTeacher(p, cls, teacher) {
        const cur = parseCell(grid.value[p]?.[cls] || '');
        setCell(p, cls, cur.subject, teacher);
      }

      function keyOf(p, cls) { return `${p}|${cls}`; }
     
      function normalizeCell(v) {
        return String(v||'').trim().replace(/\r\n/g, '\n');
      }

      function mergeBaseAndOverrides(baseTT, ov) {
        const merged = {};
        for (let p = 1; p <= 7; p++) {
          merged[p] = {};
          for (const c of classes.value) {
            const k = keyOf(p, c);
            merged[p][c] = ov[k] !== undefined ? ov[k] : (baseTT[p]?.[c] || '');
          }
        }
        return merged;
      }

      function isOverrideCell(p, cls) {
        return overrides.value[keyOf(p, cls)] !== undefined;
      }

      // â­ ëŒ€í­ ì¦ê°€ëœ ê¸€ì í¬ê¸° (ì¹¸ì— ê½‰ ì°¨ê²Œ)
      function kioskSubjectStyle(subject) {
        const t = String(subject || '').trim();
        if (!isKioskMode.value) return { fontSize: '1.65rem', lineHeight: '1.05' };
        const len = Array.from(t).length;
        let maxPx = 68;
        if (len > 8) maxPx = 62;
        if (len > 12) maxPx = 54;
        if (len > 18) maxPx = 46;
        if (len > 26) maxPx = 38;
        return { fontSize: `clamp(26px, 3.2vw, ${maxPx}px)`, lineHeight: '1.0' };
      }
     
      function kioskTeacherStyle(teacher) {
        const t = String(teacher || '').trim();
        if (!isKioskMode.value) return { fontSize: '1.25rem', lineHeight: '1.1' };
        const len = Array.from(t).length;
        let maxPx = 38;
        if (len > 8) maxPx = 34;
        if (len > 12) maxPx = 30;
        if (len > 18) maxPx = 26;
        if (len > 26) maxPx = 22;
        return { fontSize: `clamp(18px, 2.0vw, ${maxPx}px)`, lineHeight: '1.05' };
      }

      function focusField(period, cls, part) {
        const el = document.querySelector(
          `[data-period="${period}"][data-class="${cls}"][data-part="${part}"]`
        );
        if (el) { el.focus(); el.select?.(); }
      }
     
      async function handleEnter(period, cls, part) {
        if (part === 'subject') {
          await nextTick();
          focusField(period, cls, 'teacher');
          return;
        }
        const vPeriods = [1,2,3,4,5,6,7];
        const p = Number(period);
        const pIdx = vPeriods.indexOf(p);
        const cIdx = classes.value.indexOf(cls);
        if (pIdx === -1 || cIdx === -1) return;

        const nextPeriod = vPeriods[pIdx + 1];
        if (nextPeriod != null) {
          await nextTick();
          focusField(nextPeriod, cls, 'subject');
          return;
        }
        const nextClass = classes.value[cIdx + 1] || classes.value[0];
        const firstPeriod = vPeriods[0];
        await nextTick();
        focusField(firstPeriod, nextClass, 'subject');
      }

      function convertGoogleDriveUrl(url) {
        try {
          let fileId = '';
          
          if (url.includes('drive.google.com/file/d/')) {
            const parts = url.split('drive.google.com/file/d/')[1];
            if (parts) {
              fileId = parts.split('/')[0].split('?')[0];
            }
          }
          else if (url.includes('drive.google.com/open?id=')) {
            const parts = url.split('id=')[1];
            if (parts) {
              fileId = parts.split('&')[0];
            }
          }
          
          if (fileId) {
            return {
              isGoogleDrive: true,
              fileId: fileId,
              thumbnailUrl: `https://drive.google.com/thumbnail?id=${fileId}&sz=w2000`,
              previewUrl: `https://drive.google.com/file/d/${fileId}/preview`,
              displayUrl: `êµ¬ê¸€ë“œë¼ì´ë¸Œ: ${fileId.substring(0, 12)}...`,
              originalUrl: url
            };
          }
        } catch (e) {
          console.error('âŒ êµ¬ê¸€ ë“œë¼ì´ë¸Œ URL íŒŒì‹± ì˜¤ë¥˜:', e);
        }
        return null;
      }

      function toYoutubeEmbed(url) {
        try {
          const u = new URL(url);
          let id = '';
          let isShorts = false;
          
          if (u.pathname.includes('/shorts/')) {
            const parts = u.pathname.split('/shorts/')[1];
            if (parts) {
              id = parts.split('?')[0].split('/')[0];
              isShorts = true;
            }
          }
          else if (u.hostname.includes('youtu.be')) {
            id = u.pathname.replace('/', '').split('?')[0];
          }
          else if (u.hostname.includes('youtube.com')) {
            id = u.searchParams.get('v') || '';
          }
          
          if (!id) return null;
          
          if (isShorts) {
            return {
              embedUrl: `https://www.youtube.com/embed/${id}?autoplay=1&mute=0&loop=1&playlist=${id}&playsinline=1&controls=0&modestbranding=1&rel=0&fs=0&iv_load_policy=3&disablekb=1`,
              isShorts: true
            };
          } else {
            return {
              embedUrl: `https://www.youtube.com/embed/${id}?autoplay=1&mute=1&loop=1&playlist=${id}&playsinline=1&rel=0&modestbranding=1`,
              isShorts: false
            };
          }
        } catch (e) {
          console.error('âŒ URL íŒŒì‹± ì˜¤ë¥˜:', e);
          return null;
        }
      }

      async function setSlidesOnly() {
        try {
          await setDoc(configRef, { 
            schoolName: schoolName.value,
            classCounts: classCounts.value,
            slides: slides.value 
          }, { merge: true });
        } catch (error) {
          console.error('âŒ ìŠ¬ë¼ì´ë“œ ì €ì¥ ì‹¤íŒ¨:', error);
          alert('ìŠ¬ë¼ì´ë“œ ì €ì¥ ì‹¤íŒ¨: ' + error.message);
        }
      }
     
      function addSlidePrompt() {
        const url = prompt("ğŸ¬ ë¯¸ë””ì–´ URL ì…ë ¥:");
        if (!url) return;

        let slide = { url, type: 'img' };
        
        const gDrive = convertGoogleDriveUrl(url);
        if (gDrive) {
          slide = {
            url: gDrive.originalUrl,
            fileId: gDrive.fileId,
            thumbnailUrl: gDrive.thumbnailUrl,
            previewUrl: gDrive.previewUrl,
            displayUrl: gDrive.displayUrl,
            type: 'gdrive-image'
          };
          
          const mediaType = prompt("ğŸ“ êµ¬ê¸€ ë“œë¼ì´ë¸Œ íŒŒì¼ íƒ€ì…:\n\n1 = ì´ë¯¸ì§€\n2 = ë¹„ë””ì˜¤", "1");
          
          if (mediaType === "2") {
            slide.type = 'gdrive-video';
          }
        }
        else {
          const ytResult = toYoutubeEmbed(url);
          if (ytResult) { 
            slide.type = ytResult.isShorts ? 'youtube-shorts' : 'youtube';
            slide.embedUrl = ytResult.embedUrl;
          }
          else {
            const lowerUrl = url.toLowerCase();
            if (lowerUrl.includes('.mp4') || lowerUrl.includes('.webm') || 
                lowerUrl.includes('.ogg') || lowerUrl.includes('.mov') || 
                lowerUrl.includes('.avi')) {
              slide.type = 'video';
            }
          }
        }

        slides.value = [...slides.value, slide];
        setSlidesOnly();
      }
     
      function deleteSlide(idx) {
        if (!confirm("ì´ ìŠ¬ë¼ì´ë“œë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;
        const ns = slides.value.filter((_, i) => i !== idx);
        slides.value = ns;
        if (currentSlideIndex.value >= ns.length) currentSlideIndex.value = 0;
        setSlidesOnly();
      }
     
      function moveSlide(idx, dir) {
        const ni = idx + dir;
        if (ni < 0 || ni >= slides.value.length) return;
        const ns = [...slides.value];
        [ns[idx], ns[ni]] = [ns[ni], ns[idx]];
        slides.value = ns;
        setSlidesOnly();
      }

      function getSlideDuration(slide) {
        if (!slide) return 8000;
        
        switch(slide.type) {
          case 'youtube-shorts':  return 120000;
          case 'youtube':         return 15000;
          case 'gdrive-video':
          case 'video':           return 30000;
          default:                return 8000;
        }
      }

      function startSlideTimer() {
        if (slideTimer.value) {
          clearTimeout(slideTimer.value);
        }
        
        if (slides.value.length === 0 || !showSlides.value) return;
        
        const currentSlide = slides.value[currentSlideIndex.value];
        const duration = getSlideDuration(currentSlide);
        
        slideTimer.value = setTimeout(() => {
          currentSlideIndex.value = (currentSlideIndex.value + 1) % slides.value.length;
          
          nextTick(() => {
            const videos = document.querySelectorAll('video');
            videos.forEach(v => {
              if (v.offsetParent !== null) {
                v.play().catch(e => console.warn('âš ï¸ ì¬ìƒ ì‹¤íŒ¨:', e));
              }
            });
          });
          
          startSlideTimer();
        }, duration);
      }

      // ğŸ”„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ê¸°ëŠ¥
      function loadDayData() {
        const day = selectedDay.value;
       
        if (unsubscribeTimetable) {
          unsubscribeTimetable();
        }

        try {
          const dayRef = doc(db, "timetables", day);
          
          unsubscribeTimetable = onSnapshot(dayRef, (snap) => {
            if (!snap.exists()) {
              base.value = makeEmptyTimetable();
              baseEvents.value = {};
              overrides.value = {};
              events.value = {};
              grid.value = makeEmptyTimetable();
              return;
            }
           
            const d = snap.data();
            base.value = d.base || makeEmptyTimetable();
            baseEvents.value = d.baseEvents || {};
            overrides.value = d.overrides || {};
            events.value = d.events || d.baseEvents || {};
            grid.value = mergeBaseAndOverrides(base.value, overrides.value);
          }, (error) => {
            console.error('âŒ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
          });
        } catch (error) {
          console.error('âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
          alert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
        }
      }

      async function saveBase() {
        const day = selectedDay.value;
        if (!confirm(`${day}ìš”ì¼ì„ 'í•™ê¸°ì´ˆ ê¸°ë³¸ì‹œê°„í‘œ'ë¡œ ì €ì¥í• ê¹Œìš”?`)) return;
       
        try {
          const dayRef = doc(db, "timetables", day);
          await setDoc(dayRef, {
            base: JSON.parse(JSON.stringify(grid.value)),
            baseEvents: JSON.parse(JSON.stringify(events.value)),
            overrides: {},
            events: JSON.parse(JSON.stringify(events.value)),
            updatedAt: Date.now()
          });
         
          alert(`âœ… ${day}ìš”ì¼ ê¸°ë³¸ì‹œê°„í‘œ ì €ì¥ì™„ë£Œ\n\nğŸ”„ ëª¨ë“  ì»´í“¨í„°ì— ìë™ìœ¼ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤!`);
        } catch (error) {
          console.error('âŒ ì €ì¥ ì‹¤íŒ¨:', error);
          alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
        }
      }

      async function loadBaseToGrid() {
        grid.value = JSON.parse(JSON.stringify(base.value));
        events.value = JSON.parse(JSON.stringify(baseEvents.value));
        overrides.value = {};
       
        alert(`âœ… ê¸°ë³¸ì‹œê°„í‘œë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
      }

      async function saveOverride() {
        const day = selectedDay.value;
        const newOverrides = {};
       
        for (let p = 1; p <= 7; p++) {
          for (const cls of classes.value) {
            const cur = normalizeCell(grid.value[p]?.[cls] || '');
            const b = normalizeCell(base.value[p]?.[cls] || '');
            if (cur !== b) {
              newOverrides[keyOf(p, cls)] = grid.value[p][cls] || '';
            }
          }
        }
       
        try {
          const dayRef = doc(db, "timetables", day);
          await setDoc(dayRef, {
            overrides: newOverrides,
            events: JSON.parse(JSON.stringify(events.value)),
            updatedAt: Date.now()
          }, { merge: true });
         
          alert(`âœ… ìˆ˜ì—…ë³€ê²½ ì €ì¥ì™„ë£Œ\n\nğŸ”„ ëª¨ë“  ì»´í“¨í„°ì— 1~2ì´ˆ ë‚´ì— ìë™ ë°˜ì˜ë©ë‹ˆë‹¤!`);
        } catch (error) {
          console.error('âŒ ì €ì¥ ì‹¤íŒ¨:', error);
          alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
        }
      }

      function openEventModal() {
        eventForm.value = {
          period: '',
          type: 'all',
          allName: '',
          gradeNames: { 1: '', 2: '', 3: '' },
          classNames: {}
        };
        for (const cls of classes.value) {
          eventForm.value.classNames[cls] = '';
        }
        showEventModal.value = true;
      }

      async function saveEvent() {
        const p = eventForm.value.period;
        if (!p) {
          alert('êµì‹œë¥¼ ì„ íƒí•˜ì„¸ìš”.');
          return;
        }

        const newEvent = { type: eventForm.value.type };

        if (eventForm.value.type === 'all') {
          if (!eventForm.value.allName.trim()) {
            alert('í–‰ì‚¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
            return;
          }
          newEvent.name = eventForm.value.allName.trim();
        } else if (eventForm.value.type === 'grade') {
          newEvent.data = {};
          for (const [g, name] of Object.entries(eventForm.value.gradeNames)) {
            if (name.trim()) newEvent.data[g] = name.trim();
          }
          if (Object.keys(newEvent.data).length === 0) {
            alert('ìµœì†Œ 1ê°œ í•™ë…„ì˜ í–‰ì‚¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
            return;
          }
        } else if (eventForm.value.type === 'class') {
          newEvent.data = {};
          for (const [cls, name] of Object.entries(eventForm.value.classNames)) {
            if (name.trim()) newEvent.data[cls] = name.trim();
          }
          if (Object.keys(newEvent.data).length === 0) {
            alert('ìµœì†Œ 1ê°œ í•™ê¸‰ì˜ í–‰ì‚¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
            return;
          }
        }

        events.value[p] = newEvent;
        showEventModal.value = false;
        alert(`âœ… ${p}êµì‹œ í–‰ì‚¬ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      }

      function deleteEvent(period) {
        if (confirm(`${period}êµì‹œ í–‰ì‚¬ë¥¼ ì‚­ì œí• ê¹Œìš”?`)) {
          delete events.value[period];
        }
      }

      async function login() {
        try {
          await signInWithPopup(auth, provider);
        } catch (error) {
          console.error("âŒ ë¡œê·¸ì¸ ì˜¤ë¥˜:", error);
          alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message);
        }
      }
     
      async function logout() {
        if (confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          await signOut(auth);
          isAdminMode.value = false;
        }
      }
     
      function toggleAdmin() {
        isAdminMode.value = !isAdminMode.value;
      }

      async function toggleKiosk() {
        isKioskMode.value = !isKioskMode.value;
        try {
          if (isKioskMode.value) {
            if (!document.fullscreenElement) await document.documentElement.requestFullscreen();
          } else {
            if (document.fullscreenElement) await document.exitFullscreen();
          }
        } catch (e) {
          console.warn("âš ï¸ ì „ì²´í™”ë©´ ì‹¤íŒ¨:", e);
        }
      }

      onMounted(async () => {
        console.log('ğŸš€ ìˆ˜ì—…ì‹œê°„í‘œ v3.0.2.2 ì‹œì‘');
        console.log('ğŸ“ ëŒ€í˜• ê¸€ì”¨ ëª¨ë“œ í™œì„±í™” (ì¹¸ì— ê½‰ ì°¨ê²Œ)');
        console.log('ğŸ”„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ê¸°ëŠ¥ í™œì„±í™”');
        
        document.addEventListener('keydown', handleEscKey);
        
        onAuthStateChanged(auth, async (u) => {
          user.value = u;
         
          if (!u) {
            isAdminMode.value = false;
            return;
          }

          try {
            const configSnap = await onSnapshot(configRef, (snap) => {
              if (snap.exists()) {
                const d = snap.data();
                if (d.schoolName) schoolName.value = d.schoolName;
                if (d.classCounts) classCounts.value = d.classCounts;
                if (Array.isArray(d.slides)) slides.value = d.slides;
              }
            });
          } catch (error) {
            console.error('âŒ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
          }

          loadDayData();
          startSlideTimer();
        });
      });

      onUnmounted(() => {
        if (unsubscribeTimetable) {
          unsubscribeTimetable();
        }
      });

      return {
        todayDateStr, todayDayLabel,
        user, userName, isAdminMode, isKioskMode,
        isFirebaseConfigured,
        login, logout, toggleAdmin, toggleKiosk,
        weekdays,
        selectedDay,
        slides, currentSlideIndex,
        showSlides, toggleSlides,
        slideFullscreen, toggleSlideFullscreen,
        slideAreaStyle, mainAreaStyle,
        addSlidePrompt, deleteSlide, moveSlide,
        onVideoLoaded, onImageLoaded,
        handleMediaError, playVideo,
        schoolName, classCounts,
        showSettingsModal, tempSchoolName, tempClassCounts,
        openSettings, saveSettings,
        classes, classLabel,
        colHeaderBg, colBodyBg,
        tableRows, rowStyle,
        isFixedThursdayCreative,
        getEventGroups,
        grid,
        getSubject, getTeacher,
        setCellSubject, setCellTeacher,
        isOverrideCell,
        getCellBgClass,
        getEventCellBgClass,
        handleEnter,
        loadDayData,
        saveBase,
        loadBaseToGrid,
        saveOverride,
        showEventModal,
        openEventModal,
        eventForm,
        saveEvent,
        deleteEvent,
        formatEventDisplay,
        events,
        kioskSubjectStyle,
        kioskTeacherStyle,
        showManual
      };
    }
  }).mount('#app');
</script>
</body>
</html>
